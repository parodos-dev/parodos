package com.redhat.parodos.tasks.migrationtoolkit;

import java.util.UUID;

import com.redhat.parodos.workflow.context.WorkContextDelegate;
import com.redhat.parodos.workflow.exception.MissingParameterException;
import com.redhat.parodos.workflow.task.log.WorkFlowTaskLogger;
import com.redhat.parodos.workflows.work.WorkContext;
import com.redhat.parodos.workflows.work.WorkReport;
import com.redhat.parodos.workflows.work.WorkStatus;
import lombok.SneakyThrows;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;

import static com.redhat.parodos.tasks.migrationtoolkit.TestConsts.APP_ID;
import static com.redhat.parodos.tasks.migrationtoolkit.TestConsts.APP_NAME;
import static com.redhat.parodos.tasks.migrationtoolkit.TestConsts.REPO_BRANCH;
import static com.redhat.parodos.tasks.migrationtoolkit.TestConsts.REPO_URL;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.Matchers.notNullValue;
import static org.hamcrest.Matchers.nullValue;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.ArgumentMatchers.isNull;
import static org.mockito.Mockito.any;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.mockito.MockitoAnnotations.openMocks;

public class CreateApplicationTaskTest {

	CreateApplicationTask underTest;

	@Mock
	MTAApplicationClient mockClient;

	@Mock
	WorkFlowTaskLogger taskLoggerMock;

	WorkContext ctx;

	@BeforeEach
	public void setUp() {
		openMocks(this);
		underTest = spy(new CreateApplicationTask());
		underTest.mtaClient = mockClient;
		underTest.setBeanName("CreateApplicationTask");
		underTest.taskLogger = taskLoggerMock;
		ctx = new WorkContext();
	}

	@Test
	@SneakyThrows
	public void missingMandatoryParameters() {
		WorkContextDelegate.write(ctx, WorkContextDelegate.ProcessType.WORKFLOW_EXECUTION,
				WorkContextDelegate.Resource.ID, UUID.randomUUID());
		underTest.preExecute(ctx);
		WorkReport execute = underTest.execute(ctx);

		assertThat(execute.getError(), is(instanceOf(MissingParameterException.class)));
		assertThat(execute.getStatus(), equalTo(WorkStatus.FAILED));
		assertThat(execute.getWorkContext().get("application"), is(nullValue()));
		verify(mockClient, times(0)).create(any());
	}

	@Test
	@SneakyThrows
	public void createFails() {
		when(mockClient.create(any(App.class))).thenReturn(new Result.Failure<>(new Exception("some error from MTA")));
		doReturn(APP_NAME).when(this.underTest).getRequiredParameterValue(eq("applicationName"));
		doReturn(REPO_URL).when(this.underTest).getRequiredParameterValue(eq("repositoryURL"));

		ctx.put("applicationName", APP_NAME);
		ctx.put("repositoryURL", REPO_URL);
		WorkContextDelegate.write(ctx, WorkContextDelegate.ProcessType.WORKFLOW_EXECUTION,
				WorkContextDelegate.Resource.ID, UUID.randomUUID());
		underTest.preExecute(ctx);
		WorkReport execute = underTest.execute(ctx);

		assertThat(execute.getError(), is(instanceOf(Exception.class)));
		assertThat(execute.getError(), is(instanceOf(Exception.class)));
		assertThat(execute.getStatus(), equalTo(WorkStatus.FAILED));
		assertThat(execute.getWorkContext().get("application"), is(nullValue()));
		verify(mockClient, times(1)).create(any());
	}

	@Test
	@SneakyThrows
	public void createCompletes() {
		ctx.put("applicationName", APP_NAME);
		ctx.put("repositoryURL", REPO_URL);
		ctx.put("branch", REPO_BRANCH);

		doReturn(APP_NAME).when(this.underTest).getOptionalParameterValue(eq("applicationName"), eq(""));
		doReturn(REPO_URL).when(this.underTest).getRequiredParameterValue(eq("repositoryURL"));
		doReturn(REPO_BRANCH).when(this.underTest).getOptionalParameterValue(eq("branch"), isNull());

		when(mockClient.create(any())).thenReturn(
				new Result.Success<>(new App(APP_ID, APP_NAME, new Repository("git", REPO_URL, REPO_BRANCH), null)));
		WorkContextDelegate.write(ctx, WorkContextDelegate.ProcessType.WORKFLOW_EXECUTION,
				WorkContextDelegate.Resource.ID, UUID.randomUUID());
		underTest.preExecute(ctx);
		WorkReport execute = underTest.execute(ctx);

		assertThat(execute.getError(), is(nullValue()));
		assertThat(execute.getStatus(), equalTo(WorkStatus.COMPLETED));
		assertThat(((App) execute.getWorkContext().get("application")), notNullValue());
		assertThat(((App) execute.getWorkContext().get("application")).identities(), nullValue());
		assertThat((App) execute.getWorkContext().get("application"),
				equalTo(new App(APP_ID, APP_NAME, new Repository("git", REPO_URL, REPO_BRANCH), null)));

		// 0 is wanted explicitly because it is an empty ID for the server request. (IDs
		// are generated by the server)
		verify(mockClient, times(1))
				.create(new App("0", APP_NAME, new Repository("git", REPO_URL, REPO_BRANCH), any()));
	}

}
